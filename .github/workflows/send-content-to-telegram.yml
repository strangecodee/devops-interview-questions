name: Send Daily DevOps Content to Telegram

on:
  workflow_run:
    workflows:
      - "Daily DevOps Content Generator (HuggingFace)"
    types:
      - completed

jobs:
  send_telegram:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Find today's content files
        run: |
          DATE=$(date +'%Y-%m-%d')
          echo "DATE=$DATE" >> $GITHUB_ENV
          
          # Find files created today with the timestamp format (YYYY-MM-DD_HH-MM.md)
          for category in devops-interview docker kubernetes cicd; do
            # Find files that start with today's date followed by underscore and time
            FILE=$(find $category -name "$DATE*.md" -type f -newer /dev/null 2>/dev/null | head -n 1)
            if [ -n "$FILE" ] && [ -f "$FILE" ]; then
              echo "${category^^}_FILE=$FILE" >> $GITHUB_ENV
              echo "Found $category file: $FILE"
            else
              echo "${category^^}_FILE=" >> $GITHUB_ENV
              echo "No $category file found for today"
            fi
          done

      - name: Send DevOps Content to Telegram
        env:
          BOT: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          send_message () {
            TEXT="$1"
            curl -s -X POST "https://api.telegram.org/bot$BOT/sendMessage" \
              -d chat_id="$CHAT" \
              -d parse_mode="Markdown" \
              --data-urlencode text="$TEXT" > /dev/null
          }

          DATE="${{ env.DATE }}"
          
          # Define folder mapping using environment variables
          DEVOPS_FILE="${{ env.DEVOPS_INTERVIEW_FILE }}"
          DOCKER_FILE="${{ env.DOCKER_FILE }}"
          KUBE_FILE="${{ env.KUBERNETES_FILE }}"
          CICD_FILE="${{ env.CICD_FILE }}"

          # Send available content files to Telegram
          declare -A folders=(
            ["DevOps Interview"]="$DEVOPS_FILE"
            ["Docker Tip"]="$DOCKER_FILE"
            ["Kubernetes Example"]="$KUBE_FILE"
            ["CI/CD Tip"]="$CICD_FILE"
          )

          FOUND_ANY=false
          for NAME in "${!folders[@]}"; do
            FILE="${folders[$NAME]}"

            if [ -n "$FILE" ] && [ -f "$FILE" ]; then
              # Extract content (excluding header metadata)
              CONTENT=$(sed -n '/^$/,$p' "$FILE" | sed '/^$/q;d')  # Skip headers until first blank line
              
              # Get the actual content from the file (skip initial metadata)
              FULL_CONTENT=$(tail -n +7 "$FILE")  # Skip first 6 lines of metadata
              
              # Limit content size for Telegram (max 4096 chars)
              TRUNCATED_CONTENT=$(echo "$FULL_CONTENT" | head -c 3000)
              
              MESSAGE="üìò *$NAME*  
            üìÖ Date: $DATE

            $TRUNCATED_CONTENT"

              # Send message to Telegram
              send_message "$MESSAGE"
              sleep 2
              FOUND_ANY=true
            fi
          done

          if [ "$FOUND_ANY" = true ]; then
            send_message "‚úÖ All available DevOps content for $DATE has been sent!"
          else
            send_message "‚ùå No content files found for $DATE. Check if content generator ran successfully."
          fi
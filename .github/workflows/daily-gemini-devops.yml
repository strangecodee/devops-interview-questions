name: Daily DevOps Content Generator (Gemini)

on:
  schedule:
    - cron: "* * * * *"
  workflow_dispatch:

jobs:
  generate:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install dependencies
        run: sudo apt-get install -y curl jq

      - name: Generate DevOps content
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          set -e

          # Set IST timezone
          export TZ="Asia/Kolkata"

          # ───────────────────────────────────────────────
          # RANDOMIZATION ENGINE (guarantees uniqueness)
          # ───────────────────────────────────────────────

          RANDOM_TOPIC=$(
            printf "%s\n" \
            AWS Terraform Helm GitOps ArgoCD Istio SRE Scalability Monitoring \
            "Load Balancing" "Zero-Downtime Deploys" "Kubernetes Security" \
            "Docker Layers" "Chaos Engineering" | shuf -n 1
          )

          RANDOM_SEED=$(date +%s)

          STYLE=$(
            printf "%s\n" \
            "Enterprise tone" \
            "SRE-focused" \
            "Security-heavy" \
            "Performance-optimized" \
            "Beginner-friendly" \
            "Verbose explanation" \
            "Short and concise" | shuf -n 1
          )

          DEPTH=$(
            printf "%s\n" \
            "Low detail" \
            "Medium detail" \
            "High detail" \
            "Very high detail" | shuf -n 1
          )

          UNIQUE_KEYWORD=$(
            printf "%s\n" \
            phoenix nebula quantum atlas vector eclipse forge pulse matrix sentinel velocity spectrum nova titan \
            | shuf -n 1
          )

          echo "Topic: $RANDOM_TOPIC"
          echo "Seed: $RANDOM_SEED"
          echo "Style: $STYLE"
          echo "Depth: $DEPTH"
          echo "Keyword: $UNIQUE_KEYWORD"

          categories_list="devops-interview docker kubernetes cicd"

          # ───────────────────────────────────────────────
          # GENERATE CONTENT FOR EACH CATEGORY
          # ───────────────────────────────────────────────
          for key in ${categories_list}; do
            prompt_file="prompts/${key}.txt"
            base_prompt=$(cat "$prompt_file")

            # Final prompt with unique modifiers
            prompt="${base_prompt}
            Style --> ${STYLE}
            Depth --> ${DEPTH}
            UniqueKeyword --> ${UNIQUE_KEYWORD}
            Topic --> ${RANDOM_TOPIC}
            Seed --> ${RANDOM_SEED}
            "

            mkdir -p "$key"
            file="$key/$(date +'%Y-%m-%d_%H-%M').md"

            # Gemini API Request
            response=$(
              curl -s -X POST \
              -H "Content-Type: application/json" \
              -H "x-goog-api-key: $GEMINI_API_KEY" \
              -d "$(jq -n --arg p "$prompt" '{contents:[{role:"user", parts:[{text:$p}]}]}')" \
              "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent"
            )

            output=$(echo "$response" | jq -r 'try .candidates[0].content.parts[0].text catch ""')

            # Write Markdown file with IST timestamp
            echo "# ${key} — $(date)" > "$file"
            echo "**Topic:** ${RANDOM_TOPIC}" >> "$file"
            echo "**Style:** ${STYLE}" >> "$file"
            echo "**Depth:** ${DEPTH}" >> "$file"
            echo "**UniqueKeyword:** ${UNIQUE_KEYWORD}" >> "$file"
            echo "" >> "$file"
            echo "$output" >> "$file"

            echo "Saved → $file"
          done

      - name: Configure Git
        run: |
          git config --global user.name "DevOps Content Bot"
          git config --global user.email "bot@github.com"
          git remote set-url origin https://github-actions:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}

      - name: Commit and push changes
        run: |
          export TZ="Asia/Kolkata"
          git add .
          git commit -m "content: auto-generated $(date '+%Y-%m-%d %H:%M IST')" || echo "Nothing to commit"
          git pull origin main --rebase --strategy-option theirs
          git push origin main

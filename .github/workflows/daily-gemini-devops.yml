name: Daily DevOps Content Generator (Gemini)

on:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

jobs:
  generate:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      # ───────────────────────────────────────────────
      # CHECKOUT
      # ───────────────────────────────────────────────
      - name: Checkout repository
        uses: actions/checkout@v3

      # ───────────────────────────────────────────────
      # DEPENDENCIES
      # ───────────────────────────────────────────────
      - name: Install dependencies
        run: sudo apt-get install -y curl jq

      # ───────────────────────────────────────────────
      # CONTENT GENERATOR (OUTPUT FIXED)
      # ───────────────────────────────────────────────
      - name: Generate DevOps content
  id: generator
  env:
    GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
  run: |
    set -e
    export TZ="Asia/Kolkata"

    # ───── RANDOMIZATION ENGINE ─────
    RANDOM_TOPIC=$(
      printf "%s\n" \
      AWS Terraform Helm GitOps ArgoCD Istio SRE Scalability Monitoring \
      "Load Balancing" "Zero-Downtime Deploys" "Kubernetes Security" \
      "Docker Layers" "Chaos Engineering" | shuf -n 1
    )

    RANDOM_SEED=$(date +%s)

    STYLE=$(
      printf "%s\n" \
      "Enterprise tone" \
      "SRE-focused" \
      "Security-heavy" \
      "Performance-optimized" \
      "Beginner-friendly" \
      "Short and concise" | shuf -n 1
    )

    DEPTH=$(
      printf "%s\n" \
      "Low detail" \
      "Medium detail" \
      "High detail" | shuf -n 1
    )

    UNIQUE_KEYWORD=$(
      printf "%s\n" \
      phoenix nebula quantum atlas vector eclipse forge pulse matrix sentinel \
      | shuf -n 1
    )

    # ✅ EXPORT OUTPUTS IMMEDIATELY (CRITICAL)
    {
      echo "topic=$RANDOM_TOPIC"
      echo "style=$STYLE"
      echo "depth=$DEPTH"
      echo "keyword=$UNIQUE_KEYWORD"
      echo "seed=$RANDOM_SEED"
    } >> "$GITHUB_OUTPUT"

    echo "Topic: $RANDOM_TOPIC"
    echo "Style: $STYLE"
    echo "Depth: $DEPTH"
    echo "Keyword: $UNIQUE_KEYWORD"

    categories_list="devops-interview docker kubernetes cicd"

    for key in ${categories_list}; do
      prompt_file="prompts/${key}.txt"

      # ✅ Prevent crash if file missing
      [ -f "$prompt_file" ] || continue

      base_prompt=$(cat "$prompt_file")

      prompt="${base_prompt}
      Style --> ${STYLE}
      Depth --> ${DEPTH}
      UniqueKeyword --> ${UNIQUE_KEYWORD}
      Topic --> ${RANDOM_TOPIC}
      Seed --> ${RANDOM_SEED}
      "

      mkdir -p "$key"
      file="$key/$(date +'%Y-%m-%d_%H-%M').md"

      # ✅ API call must NOT kill workflow
      response=$(curl -s --fail \
        -H "Content-Type: application/json" \
        -H "x-goog-api-key: $GEMINI_API_KEY" \
        -d "$(jq -n --arg p "$prompt" '{contents:[{role:"user",parts:[{text:$p}]}]}')" \
        "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent" \
        || echo '{}')

      output=$(echo "$response" | jq -r '.candidates[0].content.parts[0].text // "API response unavailable"')

      echo "# ${key} — $(date)" > "$file"
      echo "**Topic:** ${RANDOM_TOPIC}" >> "$file"
      echo "**Style:** ${STYLE}" >> "$file"
      echo "**Depth:** ${DEPTH}" >> "$file"
      echo "**UniqueKeyword:** ${UNIQUE_KEYWORD}" >> "$file"
      echo "" >> "$file"
      echo "$output" >> "$file"
    done
  

      # ───────────────────────────────────────────────
      # VERIFY OUTPUTS (NO MORE NULL)
      # ───────────────────────────────────────────────
      - name: Verify outputs
        run: |
          echo "Topic   → ${{ steps.generator.outputs.topic }}"
          echo "Style   → ${{ steps.generator.outputs.style }}"
          echo "Depth   → ${{ steps.generator.outputs.depth }}"
          echo "Keyword → ${{ steps.generator.outputs.keyword }}"

      # ───────────────────────────────────────────────
      # JOB SUMMARY (CLEAN UI)
      # ───────────────────────────────────────────────
      - name: Workflow Summary
        run: |
          {
            echo "## Daily DevOps Content Generator"
            echo ""
            echo "- **Topic:** ${{ steps.generator.outputs.topic }}"
            echo "- **Style:** ${{ steps.generator.outputs.style }}"
            echo "- **Depth:** ${{ steps.generator.outputs.depth }}"
            echo "- **Keyword:** ${{ steps.generator.outputs.keyword }}"
          } >> $GITHUB_STEP_SUMMARY

      # ───────────────────────────────────────────────
      # GIT CONFIG
      # ───────────────────────────────────────────────
      - name: Configure Git
        run: |
          git config --global user.name "DevOps Content Bot"
          git config --global user.email "bot@github.com"
          git remote set-url origin https://github-actions:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}

      # ───────────────────────────────────────────────
      # COMMIT & PUSH
      # ───────────────────────────────────────────────
      - name: Commit and push changes
        run: |
          export TZ="Asia/Kolkata"
          git add .
          git commit -m "content: auto-generated $(date '+%Y-%m-%d %H:%M IST')" || echo "Nothing to commit"
          git pull origin main --rebase --strategy-option theirs
          git push origin main

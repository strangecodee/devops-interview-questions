name: Update Dashboard

on:
  schedule:
    - cron: "30 0 * * *"  # Daily at 00:30 UTC
  workflow_dispatch:

jobs:
  dashboard:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Update Dashboard File
        run: |
          export LANG=C.UTF-8 LC_ALL=C.UTF-8
          export LANG=en_US.UTF-8
          export LC_ALL=en_US.UTF-8

          DASH="DASHBOARD.md"

          echo "# ðŸš€ DevOps Knowledge Hub Dashboard" > $DASH
          echo "" >> $DASH
          echo "> *Updated on: $(date -u +'%A, %B %d, %Y at %H:%M:%S UTC')*" >> $DASH
          echo "" >> $DASH
          
          INTERVIEW=$(find devops-interview -type f -name "*.md" -not -name "README.md" | wc -l)
          DOCKER=$(find docker -type f -name "*.md" -not -name "README.md" | wc -l)
          K8S=$(find kubernetes -type f -name "*.md" -not -name "README.md" | wc -l)
          CICD=$(find cicd -type f -name "*.md" -not -name "README.md" | wc -l)
          TOTAL=$((INTERVIEW + DOCKER + K8S + CICD))

          BAR_INTERVIEW=$(printf '%*s' $((INTERVIEW > 50 ? 50 : INTERVIEW)) | tr ' ' 'â–ˆ')
          BAR_DOCKER=$(printf '%*s' $((DOCKER > 50 ? 50 : DOCKER)) | tr ' ' 'â–ˆ')
          BAR_K8S=$(printf '%*s' $((K8S > 50 ? 50 : K8S)) | tr ' ' 'â–ˆ')
          BAR_CICD=$(printf '%*s' $((CICD > 50 ? 50 : CICD)) | tr ' ' 'â–ˆ')
          BAR_TOTAL=$(printf '%*s' $((TOTAL > 100 ? 50 : TOTAL/2)) | tr ' ' 'â– ')

          echo "## ðŸ“Š Repository Statistics" >> $DASH
          echo "" >> $DASH
          echo "| Category | Count | Progress |" >> $DASH
          echo "|----------|-------|----------|" >> $DASH
          echo "| ðŸŽ¯ DevOps Interview | $INTERVIEW | $BAR_INTERVIEW |" >> $DASH
          echo "| ðŸ³ Docker | $DOCKER | $BAR_DOCKER |" >> $DASH
          echo "| â˜¸ï¸ Kubernetes | $K8S | $BAR_K8S |" >> $DASH
          echo "| âš™ï¸ CI/CD | $CICD | $BAR_CICD |" >> $DASH
          echo "| ðŸ“š Total | $TOTAL | $BAR_TOTAL |" >> $DASH
          echo "" >> $DASH

          echo "## ðŸ“š Latest Content by Category" >> $DASH
          echo "" >> $DASH

          format_category() {
            local dir=$1
            local emoji=$2
            local title=$3
            
            echo "### $emoji $title" >> $DASH
            echo "" >> $DASH
            
            if [ -d "$dir" ]; then
              files=$(find "$dir" -type f -name "*.md" -not -name "README.md" | sort -r | head -10)
              if [ -n "$files" ]; then
                for file in $files; do
                  topic=$(head -n 10 "$file" | grep -E "(# |Topic:|\\*\\*Topic:)" | head -1 | sed 's/# //; s/Topic: //; s/\\*\\*Topic: //; s/ â€”.*//')
                  [ -z "$topic" ] && topic="DevOps Content"
                  echo "  ðŸ“ [${topic:0:60}${topic:60:+...}]($file)" >> $DASH
                done
              else
                echo "  *No content available*" >> $DASH
              fi
            else
              echo "  *Directory does not exist*" >> $DASH
            fi
            echo "" >> $DASH
          }

          format_category "devops-interview" "ðŸŽ¯" "DevOps Interview Questions"
          format_category "docker" "ðŸ³" "Docker & Containerization"
          format_category "kubernetes" "â˜¸ï¸" "Kubernetes Orchestration"
          format_category "cicd" "âš™ï¸" "CI/CD Pipelines"

          echo "## ðŸ† Quick Stats" >> $DASH
          echo "" >> $DASH
          echo "- ðŸ“… **Last Update**: $(date -u +'%B %d, %Y')" >> $DASH
          echo "- ðŸš€ **Total Resources**: $TOTAL articles" >> $DASH
          echo "- ðŸ”„ **Daily Updates**: Automated content generation" >> $DASH
          echo "- ðŸ’¡ **Topics Covered**: DevOps best practices, Docker, Kubernetes, CI/CD" >> $DASH
          echo "" >> $DASH

          echo "---" >> $DASH
          echo "" >> $DASH
          echo "*ðŸ’¡ Pro tip: Check back daily for fresh DevOps content and insights!*" >> $DASH

      - name: Configure Git
        run: |
          git config --global user.name "Dashboard Bot"
          git config --global user.email "bot@github.com"
          git remote set-url origin https://github-actions:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}

      - name: Commit dashboard update
        run: |
          git add DASHBOARD.md
          git commit -m "docs(dashboard): auto-update dashboard" || echo "No changes to commit"
          git pull --rebase origin main
          git push origin main || echo "Push failed, trying merge"

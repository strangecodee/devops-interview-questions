name: Update Dashboard

on:
  schedule:
    - cron: "30 0 * * *"
  workflow_dispatch:

jobs:
  dashboard:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Generate Dashboard
        run: |
          export LANG=C.UTF-8
          export LC_ALL=C.UTF-8

          DASH="DASHBOARD.md"

          make_bar() {
            local value=$1
            local max=$2
            local width=30
            local filled=$(( value * width / max ))
            local empty=$(( width - filled ))

            printf "["
            printf "%0.s#" $(seq 1 $filled)
            printf "%0.s." $(seq 1 $empty)
            printf "]"
          }

          echo '<p align="center"><img src="https://raw.githubusercontent.com/SamHerbert/SVG-Loaders/master/svg-loaders/rings.svg" width="80"/></p>' > $DASH
          echo '<h1><img src="https://cdn.simpleicons.org/linux" width="26"/> DevOps Knowledge Hub Dashboard</h1>' >> $DASH
          echo "" >> $DASH
          echo "> Updated on: $(date -u +'%A, %B %d, %Y at %H:%M:%S UTC')" >> $DASH
          echo "" >> $DASH

          echo "```" >> $DASH
          echo "Booting DevOps Knowledge Hub..." >> $DASH
          echo "[▓▓▓▓▓▓▓▓▓░░░░░░░░░░] 50%  Loading Docker Modules" >> $DASH
          echo "[▓▓▓▓▓▓▓▓▓▓▓▓░░░░░░] 70%  Starting Kubernetes Pods" >> $DASH
          echo "[▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓░░] 90%  Warming CI/CD Pipelines" >> $DASH
          echo "[▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓] 100% Dashboard Ready" >> $DASH
          echo "```" >> $DASH
          echo "" >> $DASH

          INTERVIEW=$(find devops-interview -type f -name "*.md" -not -name "README.md" | wc -l)
          DOCKER=$(find docker -type f -name "*.md" -not -name "README.md" | wc -l)
          K8S=$(find kubernetes -type f -name "*.md" -not -name "README.md" | wc -l)
          CICD=$(find cicd -type f -name "*.md" -not -name "README.md" | wc -l)
          TOTAL=$((INTERVIEW + DOCKER + K8S + CICD))

          BAR_INTERVIEW=$(make_bar $INTERVIEW 100)
          BAR_DOCKER=$(make_bar $DOCKER 100)
          BAR_K8S=$(make_bar $K8S 100)
          BAR_CICD=$(make_bar $CICD 100)
          BAR_TOTAL=$(make_bar $TOTAL 400)

          echo '<h2><img src="https://cdn.simpleicons.org/github" width="20"/> Repository Statistics</h2>' >> $DASH
          echo "" >> $DASH
          echo "| Category | Count | Progress |" >> $DASH
          echo "|----------|-------|----------|" >> $DASH
          echo "| DevOps Interview | $INTERVIEW | $BAR_INTERVIEW |" >> $DASH
          echo "| Docker | $DOCKER | $BAR_DOCKER |" >> $DASH
          echo "| Kubernetes | $K8S | $BAR_K8S |" >> $DASH
          echo "| CI/CD | $CICD | $BAR_CICD |" >> $DASH
          echo "| Total | $TOTAL | $BAR_TOTAL |" >> $DASH
          echo "" >> $DASH

          echo '<h2><img src="https://cdn.simpleicons.org/bookstack" width="20"/> Latest Content by Category</h2>' >> $DASH
          echo "" >> $DASH

          format_category() {
            local dir=$1
            local icon=$2
            local title=$3

            echo "<h3><img src=\"$icon\" width=\"18\"/> $title</h3>" >> $DASH
            echo "" >> $DASH

            files=$(find "$dir" -type f -name "*.md" -not -name "README.md" | sort -r | head -10)
            for file in $files; do
              topic=$(head -n 10 "$file" | grep -E "(# |Topic:|\\*\\*Topic:)" | head -1 | sed 's/# //; s/Topic: //; s/\\*\\*Topic: //')
              [ -z "$topic" ] && topic="DevOps Content"
              echo "  - [$topic]($file)" >> $DASH
            done
            echo "" >> $DASH
          }

          format_category "devops-interview" "https://cdn.simpleicons.org/linux" "DevOps Interview Questions"
          format_category "docker" "https://cdn.simpleicons.org/docker" "Docker & Containerization"
          format_category "kubernetes" "https://cdn.simpleicons.org/kubernetes" "Kubernetes Orchestration"
          format_category "cicd" "https://cdn.simpleicons.org/jenkins" "CI/CD Pipelines"

          echo '<h2><img src="https://cdn.simpleicons.org/apachekafka" width="20"/> Quick Stats</h2>' >> $DASH
          echo "" >> $DASH
          echo "- Last Update: $(date -u +'%B %d, %Y')" >> $DASH
          echo "- Total Resources: $TOTAL articles" >> $DASH
          echo "- Daily Automation: Enabled" >> $DASH
          echo "- Tech Stack: Docker, Kubernetes, CI/CD, Linux" >> $DASH
          echo "" >> $DASH
          echo "---" >> $DASH
          echo "*Auto-generated DevOps Knowledge Dashboard*" >> $DASH

      - name: Configure Git
        run: |
          git config --global user.name "Dashboard Bot"
          git config --global user.email "bot@github.com"
          git remote set-url origin https://github-actions:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}

      - name: Commit Dashboard
        run: |
          git add DASHBOARD.md
          git commit -m "docs: auto-update DevOps dashboard" || echo "No changes"
          git pull --rebase origin main
          git push origin main

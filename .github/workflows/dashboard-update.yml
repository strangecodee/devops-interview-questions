name: Update Dashboard

on:
  schedule:
    - cron: "30 0 * * *"
  workflow_dispatch:

jobs:
  dashboard:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Update Dashboard File
        run: |
          DASH="DASHBOARD.md"

          echo "# ðŸ“Š DevOps Dashboard (Auto Updated)" > $DASH
          echo "" >> $DASH
          echo "Last Updated: $(date)" >> $DASH
          echo "" >> $DASH

          for dir in devops-interview docker kubernetes cicd; do
            echo "## ðŸ”¹ $dir" >> $DASH
            echo "" >> $DASH

            if [ -d "$dir" ]; then
              # Get all files in the directory, not just recent ones
              if ls $dir/*.md 1> /dev/null 2>&1; then
                find "$dir" -type f -name "*.md" -not -name "README.md" | sort -r | head -20 | while read file; do
                  echo "- [$file]($file)" >> $DASH
                done
              else
                echo "No content files found in $dir" >> $DASH
              fi
            else
              echo "Directory $dir does not exist" >> $DASH
            fi

            echo "" >> $DASH
          done

      - name: Configure Git
        run: |
          git config --global user.name "Dashboard Bot"
          git config --global user.email "bot@github.com"
          git remote set-url origin https://github-actions:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}

      - name: Commit dashboard update
        run: |
          git add DASHBOARD.md
          git commit -m "docs(dashboard): auto-update dashboard" || echo "No changes to commit"
          git pull --rebase origin main
          git push origin main || echo "Push failed, trying merge"